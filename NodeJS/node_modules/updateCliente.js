/*--------------------------------------------------------------------------------------------------------------------*/
/* Mockup
   Sistema de Mesa de Ayuda
   Ingeniería de Software I
   FCyT UADER

   Dr. Pedro E. Colla
   (c) 2023
   Solo utilizar para propósitos académicos
*/


    import { systemURL } from './systemURL.js';
    import { RESTAPI   } from './systemURL.js';


    const formE1=document.querySelector('.form');
    
    
/*---
Extrae del URL el id de cliente ya validado, su nombre y la última fecha de login, actualiza banner de seguridad
*/

var session = localStorage.getItem("MesaAyuda");
var id = JSON.parse(session).clienteID;
var nombre = JSON.parse(session).nombre;
var fecha_ultimo_ingreso = JSON.parse(session).fecha_ultimo_ingreso;


var activo=false;
var registrado=false;
var primera_vez=false;
var fecha_alta="";
var fecha_cambio_password=""; 
var password="";

const cliente = {
    "id" : id,
};
    
const options = {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    body: JSON.stringify(cliente),
    };

console.log("API REST:"+RESTAPI.getCliente+"/"+id)
console.log("cliente:"+JSON.stringify(cliente));
console.log("options: "+JSON.stringify(options));

fetch(`${RESTAPI.getCliente+"/"+id}`,options)
.then(res => {
    return res.json();
}).then(c=>{
   console.log("cliente: "+JSON.stringify(c));
   document.getElementById("id").innerHTML=c.cliente.id;
   document.getElementsByName("nombre")[0].value = c.cliente.nombre;
   document.getElementById("status").innerHTML="<br>Activo("+c.cliente.activo+")<br> Registrado("+c.cliente.registrado+")<br><br> fecha alta("+c.cliente.fecha_alta+")<br> fecha ultimo ingreso("+c.cliente.fecha_ultimo_ingreso+")<br> fecha cambio password("+c.cliente.fecha_cambio_password+")<br><br>";
   
   nombre=c.cliente.nombre;
   password=c.cliente.password;
   activo=c.cliente.activo;
   registrado=c.cliente.registrado;

});    
    /*---
    Intercepta el submit del formulario
    */

    formE1.addEventListener('submit',  event => {

        event.preventDefault();
        const formData = new FormData(formE1);
        const data = Object.fromEntries(formData);

        console.log("Form data->"+JSON.stringify(data));

        /*---
        Realiza validaciones en los datos del formulario antes de procesar
        */

        if (data.password != data.dupepassword) {
            console.log('las passwords deben ser diferentes id:'+data.id+" password:"+data.password+" dupe:"+data.dupepassword);
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Las passwords deben coincidir';
            return;
        }

        if (data.nombre == '') {
            console.log('debe indicar nombre');
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Debe indicar nombre';
            return;
        }

        /*---
        Forma URL para acceder, typicode es un fake API REST para pruebas
        */
        //const testLoginURL='https://my-json-server.typicode.com/lu7did/testJASON/posts/';
        //const api_LoginURL=testLoginURL+data.id;

        if (data.password != '') {
            if (data.password == data.dupepassword) {
                password = data.password;
            }
        }

        const HTMLResponse=document.querySelector("#app");
        const ul=document.createElement("ul");

        const tpl=document.createDocumentFragment();

        const update = {
            "id"                    : id,
            "password"              : password,
            "nombre"                : data.nombre,
            "activo"                : activo,
            "registrado"            : registrado
        };
            
        const options = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify(update),
            };

        console.log("REST API:"+RESTAPI.updateCliente)
        console.log("update:"+JSON.stringify(update));
        console.log("options:"+JSON.stringify(options));
        /*-----
        Realiza el acceso al API Rest utilizando gestión de sincronización mediante promesas
        */
        
        fetch(`${RESTAPI.updateCliente}`,options)
        .then(res => {
            return res.json();
        }).then(users=>{
            console.log(JSON.stringify(users));
            localStorage.clear();
            const mysession="MesaAyuda";
            var session = {'clienteID': users.data.Attributes.id,"nombre" : users.data.Attributes.nombre,"fecha_ultimo_ingreso":users.data.Attributes.fecha_ultimo_ingreso};
            localStorage.setItem(mysession,JSON.stringify(session));
            window.location.href = systemURL.listarTicket;
        })
    });
