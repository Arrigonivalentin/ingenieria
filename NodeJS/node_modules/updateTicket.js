/*--------------------------------------------------------------------------------------------------------------------*/
/* Mockup
   Sistema de Mesa de Ayuda
   Ingeniería de Software I
   FCyT UADER

   Dr. Pedro E. Colla
   (c) 2023
   Solo utilizar para propósitos académicos
*/

/*---
Función para procesar los parámetros recibidos en el URL
*/
function getQueryParams(qs) {
    qs = qs.split('+').join(' ');

    var params = {},
        tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;

    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
    }

    return params;
}
function javascript_abort()
{
   throw new Error('This is not an error. This is just to abort javascript');
}

import { systemURL } from './systemURL.js';
import { RESTAPI   } from './systemURL.js';

/*---
Extrae del URL el id de cliente ya validado, su nombre y la última fecha de login, actualiza banner de seguridad
*/

var session = localStorage.getItem("MesaAyuda");
var clienteID = JSON.parse(session).clienteID;
var nombre = JSON.parse(session).nombre;
var fecha_ultimo_ingreso = JSON.parse(session).fecha_ultimo_ingreso;

var estado_solucion;
var fecha_apertura;
var ultimo_contacto;
var solucion;
var descripcion;


/*---
Accede a REST API para obtener detalle del ticket 
Tener en cuenta que typicode es un fake REST API
*/
//const APIREST_URL='http://my-json-server.typicode.com/lu7did/testJASON/ticket/';
//const APIREST_URL='https://xe3qolsgh0.execute-api.us-east-1.amazonaws.com/listarTicketGET?clienteID='+query.id;

const formE1=document.querySelector('.form');

/*---
Obtiene el ticket Id desde los argumentos
*/
var query = getQueryParams(document.location.search);
console.log("Ticket id received is("+query.id+")");
if (!query.id) {
    document.getElementById("lastlogin").innerHTML = "<center>*ERROR* Ticket ID no informado</center>";
    console.log("Ticket no informado");
    javascript_abort();
}
const id=query.id;

const headerText="<table><tr><td>Cliente</td><td>"+clienteID+" <a href='http://"+systemURL.updateCliente+"'>(editar)</a></td></tr><tr><td>Nombre</td><td>"+nombre+"</td></tr><tr><td>Ultimo ingreso</td><td>"+fecha_ultimo_ingreso+"</td></tr></table>";
document.getElementById("lastlogin").innerHTML = headerText;
document.getElementById("id").innerHTML="Ticket: "+id;

const ticket = {
    "id" : id,
};
    
const options = {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    body: JSON.stringify(ticket),
    };

console.log("API REST:"+RESTAPI.getTicket);    
console.log("ticket:"+JSON.stringify(ticket));
console.log("options : "+JSON.stringify(options));

fetch(`${RESTAPI.getTicket}`,options)
.then(res => {
    return res.json();
}).then(t=>{

    document.getElementById("solucion").innerHTML=t.data.Item.solucion;
    document.getElementById("descripcion").innerHTML=t.data.Item.descripcion.replace('\n','<br/>');

    var s=0;
    switch(t.data.Item.estado_solucion) {
        case 0 : s='inicial'; break;
        case 1 : s='1er nivel'; break;
        case 2 : s='2do nivel'; break;
        case 3 : s='cerrado'; break;

    }

    document.getElementById("status").innerHTML="Estado de Solucion {"+s+"}</br> Fecha apertura: "+t.data.Item.fecha_apertura+"<br> Fecha ultimo contacto: "+t.data.Item.ultimo_contacto;
    estado_solucion=t.data.Item.estado_solucion;
    fecha_apertura=t.data.Item.fecha_apertura;
    ultimo_contacto=t.data.Item.ultimo_contacto;
    solucion=t.data.Item.solucion;
    descripcion=t.data.Item.descripcion;
});    


formE1.addEventListener('submit',  event => {

    event.preventDefault();
    const formData = new FormData(formE1);
    const data = Object.fromEntries(formData);

    console.log("Form data:"+JSON.stringify(data));

    const HTMLResponse=document.querySelector("#app");

    var hoy = new Date();
    var dd = String(hoy.getDate()).padStart(2, '0');
    var mm = String(hoy.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = hoy.getFullYear();
    hoy = dd + '/' + mm + '/' + yyyy;


    const ticketUpdate = {
         "id" : id,
         "clienteID" : clienteID,
         "estado_solucion" : estado_solucion,
         "solucion"  : solucion,
         "descripcion" : descripcion.replace('<br/>','\n')+"\n{"+clienteID+"} fecha:"+hoy+"\n"+data.descripcion+"\n",
         "fecha_apertura" : fecha_apertura
    };
    

    const optionsUpdate = {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify(ticketUpdate),
    };
    console.log("API REST:"+RESTAPI.updateTicket);
    console.log("ticketUpdate:"+JSON.stringify(ticket));
    console.log("options : "+JSON.stringify(optionsUpdate));

    fetch(`${RESTAPI.updateTicket}`,optionsUpdate)
    .then(res => {
        return res.json();
    }).then(ticket=>{
        window.location.href = systemURL.listarTicket;
    });    
    
})