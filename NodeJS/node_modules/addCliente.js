
/*--------------------------------------------------------------------------------------------------------------------*/
/* Mockup
   Sistema de Mesa de Ayuda
   Ingeniería de Software I
   FCyT UADER

   Dr. Pedro E. Colla
   (c) 2023
   Solo utilizar para propósitos académicos
*/



    const formE1=document.querySelector('.form');

    import { systemURL } from './systemURL.js';
    import { RESTAPI   } from './systemURL.js';
    
    

    /*---
    Intercepta el submit del formulario
    */

    formE1.addEventListener('submit',  event => {
        event.preventDefault();
        const formData = new FormData(formE1);
        const data = Object.fromEntries(formData);

        console.log("Form data->"+JSON.stringify(data));

        /*---
        Realiza validaciones en los datos del formulario antes de procesar
        */

        if (data.id == '' || data.password == '') {
            console.log('debe indicar usuario id:'+data.id+" password:"+data.password);
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Debe informar usuario y password para  completar el acceso';
            return;
        }

        if (data.password != data.dupepassword) {
            console.log('las passwords deben ser diferentes id:'+data.id+" password:"+data.password+" dupe:"+data.dupepassword);
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Las passwords deben coincidir';
            return;
        }

        if (data.nombre == '') {
            console.log('debe indicar nombre');
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Debe indicar nombre';
            return;
        }

        if (data.termscondition != 'on') {
            console.log('no aceptó los T&C no se puede loggear');
            document.getElementById('resultado').style.color="RED";
            document.getElementById('resultado').style.textAlign = "center";
            document.getElementById('resultado').textContent='Debe aceptar los T&C para poder usar el sistema';
            return;
        }


        /*---
        Forma URL para acceder, typicode es un fake API REST para pruebas
        */
        //const testLoginURL='https://my-json-server.typicode.com/lu7did/testJASON/posts/';
        //const api_LoginURL=testLoginURL+data.id;

        /*---
          Dirección de REST API en AWS
        */
        //const RESTapi_LoginURL="https://cgndi1qdug.execute-api.us-east-1.amazonaws.com/loginClienteEMail";
        //const api_LoginURL=RESTapi_LoginURL+"?id="+data.id+"&password="+data.password;
        //console.log("API usada "+api_LoginURL);

        /*---
        Genera objeto HTML a ser actualizado en el tag identificado como "app"
        */

        const HTMLResponse=document.querySelector("#app");
        const ul=document.createElement("ul");

        const tpl=document.createDocumentFragment();

        const add = {
            "contacto" : data.id,
            "password" : data.password,
            "nombre"   : data.nombre
        };
            
        const options = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify(add),
            };

        console.log("API_addCliente:"+RESTAPI.addCliente);
        console.log("add:"+JSON.stringify(add));
        console.log("options:"+JSON.stringify(options));
        /*-----
        Realiza el acceso al API Rest utilizando gestión de sincronización mediante promesas
        */
        
        fetch(`${RESTAPI.addCliente}`,options)
        .then(res => {
            return res.json();
        }).then(users=>{
            console.log(users);
            if (users.response == 'OK') {         //<==Habilitar esto para dejar que el API REST verifique sin exponer la password
                console.log('El cliente se dio de alta');
                console.log("id("+users.id+" nombre("+users.nombre+") fecha_ultimo_ingreso("+users.fecha_ultimo_ingreso+")");
                document.getElementById('resultado').style.color="BLACK";
                document.getElementById('resultado').textContent='Bienvenido al sistema '+users.nombre+', ultimo ingreso '+users.fecha_ultimo_ingreso;               
                localStorage.clear();
                window.location.href = systemURL.loginCliente;
            }  else {
                console.log('Error creando el cliente');
                document.getElementById('resultado').style.color="RED";
                document.getElementById('resultado').textContent='Error de creación de cliente, intente nuevamente';
            }

        })
    });
