

/*--------------------------------------------------------------------------------------------------------------------*/
/* Mockup
   Sistema de Mesa de Ayuda
   Ingeniería de Software I
   FCyT UADER

   Dr. Pedro E. Colla
   (c) 2023
   Solo utilizar para propósitos académicos
*/



/*---
Función para procesar los parámetros recibidos en el URL
*/
function getQueryParams(qs) {
    qs = qs.split('+').join(' ');

    var params = {},
        tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;

    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
    }

    return params;
}

/*---
Accede a REST API para obtener tickets
Tener en cuenta que typicode es un fake REST API
*/

import { systemURL } from './systemURL.js';
import { RESTAPI   } from './systemURL.js';

const HTMLResponse=document.querySelector("#app");

/*---
Extrae del URL el id de cliente ya validado, su nombre y la última fecha de login, actualiza banner de seguridad
*/

var session = localStorage.getItem("MesaAyuda");
var clienteID = JSON.parse(session).clienteID;
var nombre = JSON.parse(session).nombre;
var fecha_ultimo_ingreso = JSON.parse(session).fecha_ultimo_ingreso;

console.log("localStorage id("+clienteID+")  nombre("+nombre+") ultimo("+fecha_ultimo_ingreso+")");
document.getElementById("lastlogin").innerHTML = "<table><tr><td>Cliente</td><td>"+clienteID+" <a href='http://127.0.0.1:5500/updateCliente.html'>(editar)</a></td></tr><tr><td>Nombre</td><td>"+nombre+"</td></tr><tr><td>Ultimo ingreso</td><td>"+fecha_ultimo_ingreso+"</td></tr></table>";

const ticket = {
    "clienteID" : clienteID,
};
    
const options = {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    body: JSON.stringify(ticket),
    };

console.log("API_listarTicket:"+RESTAPI.listarTicket);    
console.log("ticket  :"+JSON.stringify(ticket));
console.log("options :"+JSON.stringify(options));


fetch(`${RESTAPI.listarTicket}`,options)
.then(res => {
    return res.json();
}).then(ticket=>{
    let f=false;
    let table=document.createElement("table");
    table.style.border="1px solid";
    ticket.data.forEach((t)=> {
        if (t.clienteID == clienteID) {
            if (f==false) {
                f=true;
                const hdr=["ID","Motivo","Estado","Fecha"];
                let tr=document.createElement("tr");
                tr.style.border="1px solid";
                hdr.forEach((item) => {
                    let th=document.createElement("th");
                    th.style.border="1px solid";
                    th.innerText = item;
                    tr.appendChild(th);
                });
                table.appendChild(tr);                   
            }
            const tid=`${t.id}`;
            const aref=systemURL.updateTicket+'?id='+tid;
            const st=`${t.estado_solucion}`;
            const body=["#ref",`${t.solucion}`,"#status",`${t.ultimo_contacto}`];
            let trl=document.createElement("tr");
            body.forEach((line) => {
                let td=document.createElement("td");
                td.style.border="1px solid";
                if (line=="#ref") {
                    let ax=document.createElement("a");
                    ax.href=aref;
                    ax.innerText = tid;
                    td.appendChild(ax);
                } else {
                    if (line=="#status") {
                      let bx=document.createElement("center");
                      bx.innerText= st;
                      td.appendChild(bx);
                    } else {
                      td.innerText = line;
                    }  
                }
                trl.appendChild(td);
            });
            table.appendChild(trl);                   

        }
    });

    if (f) {
        HTMLResponse.appendChild(table);
    } else {
        console.log("no tiene tickets");
        document.getElementById('mensajes').style.textAlign = "center";
        document.getElementById('mensajes').style.color="RED";
        document.getElementById("mensajes").innerHTML = "No hay tickets pendientes";
    }
});
window.onload = function() {
    document.getElementById('newticket').onsubmit = function() {
        window.location.href = systemURL.addTicket;
        return false;
    }    
}
